<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: Data structure</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">Data structure </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Handling long lists of 1s and 0s is at the heart of this project, and needs to be done as efficiently as possible. The current way all data is managed is throught a packed representation of integers such that:</p>
<p><code>ex = 0b01100111</code> or <code>ex = 103</code>,</p><ul>
<li>Drawback: for extreme cases where almost all entries are consecutively 1s or 0s, this method is slower and takes more memory space than a sparse implementation</li>
<li>Benefits:<ul>
<li>Enables native bitwise ops (AND/OR/XOR/NOT), popcount, shifts, etc.</li>
<li>SIMD, simpler/faster multithreading on most operations</li>
</ul>
</li>
</ul>
<p>Alternatives were tried, but proved to be less efficient in either memory or speed:</p>
<ol type="1">
<li><b>Binary list</b> <br  />
<code>ex = [0,1,1,0,0,1,1,1]</code>, a list of individual integers which are always either 1 or 0<ul>
<li>Drawback: each element takes up a whole byte while only one bit is needed. Poor memory density and difficult SIMD exploitation makes this approach slow in almost any scenario.</li>
</ul>
</li>
<li><b>Sparse intervals</b> <br  />
<code>ex = [(1,3),(5,8)]</code>, a list of pairs which denotes runs of consecutive 1s. <br  />
<ul>
<li>Drawback: good for very very sparse patterns but degrades rapidely to O(n). Enormous overhead for most cases.</li>
</ul>
</li>
</ol>
<hr  />
<h1><a class="anchor" id="autotoc_md25"></a>
General</h1>
<p>In most cases, we cast the data of a Z2R array to <code>uint64_t</code> via <code>std::bit_cast&lt;&gt;</code>. This is done because in most modern computers, 64 bits is the largest natively supported integer size. When an object's total size is less than 64 bits, casting is mostly on <code>uint8_t</code> and sometimes on <code>bitset&lt;N&gt;</code></p>
<h1><a class="anchor" id="autotoc_md26"></a>
Multi-threading</h1>
<p>To fully utilize available hardware, we implement multi-threading wherever safe and beneficial. OpenMP provides simple syntax with powerful results while maintaining code readability. </p>
<h2><a class="anchor" id="autotoc_md27"></a>
Using OpenMP</h2>
<p>Before adding OpenMP, make it <b>certain</b> that your code is thread-safe. Data races and memory corruption are difficult to debug. While mutexes can provide thread safety over otherwise unsafe operations, they often cause performance degradation in small functions (our primary use case). Use mutexes cautiously and verify they provide net benefits.</p>
<p>As for the syntax, most <em>for(...)</em> loops in the project are prefaced with: </p><div class="fragment"><div class="line">#ifdef USE_OPENMP</div>
<div class="line">    #pragma omp parallel for if (local_variable &gt;= SOME_MACRO) schedule(static)</div>
<div class="line">#endif</div>
<div class="line">    for (i=0; i&lt;local_variable; i++) {</div>
<div class="line">        // Code that does something which could be multi-threaded</div>
<div class="line">    }</div>
</div><!-- fragment --><ul>
<li><code>#ifdef</code> is a preprocessor directive that only compiles it's code block if the specific macro is defined. In this case, <code>USE_OPENMP</code> is our own macro, and is only ever defined within CMake's compiling instruction. This is necessary since if OpenMP is not installed but still tries to compile OMP-specific pragmas, the compiler will throw out an error and exit.</li>
<li><code>#pragma omp parallel for</code> says that we'll be using OpenMP's directives, which will pass the next <em>for(...)</em> loop to multiple threads.</li>
<li><code>if (local_variable &gt;= SOME_MACRO)</code> assures that the multithreading only occurs if the statement evaluates to True. Usually this is with a counter or size of a data point compared to an arbitrarily chosen constant.</li>
<li><code>schedule(static)</code> assign each loop iterations to threads in a even, round-robin distribution.</li>
</ul>
<p>More keywords exist, but they are specific to certain behaviors that are much less common in this project</p>
<h2><a class="anchor" id="autotoc_md28"></a>
Understanding the GIL</h2>
<p>Python's Global Interpreter Lock allows only one thread to execute Python bytecode at a time. This simplifies Python's memory management but prevents true multi-threading. Only multiprocessing can achieve true parallelism under the GIL.</p>
<p>However, it is possible to get freed from the shackles of the GIL within C++. This can be done by declaring a section like this: </p><div class="fragment"><div class="line"> {C++}</div>
<div class="line">{</div>
<div class="line">  py::gil_scoped_release release;</div>
<div class="line">  // very heavy CPU loop (Real multithreading allowed)</div>
<div class="line">}</div>
<div class="line">// The GIL is automaticaly reaquired here</div>
</div><!-- fragment --><p> Releasing the GIL has some overhead, so it is only useful when code needs to be truly parallelized. <b>Release the GIL when:</b></p><ul>
<li>Operations are CPU-intensive and long-running</li>
<li>No Python API calls are needed</li>
<li>Using OpenMP or manual threading</li>
</ul>
<p>See <code><a class="el" href="cz2m_8h.html#ae4da4fa68c447ad16c8312e9e6938628" title="This is a very early test implementation of unordered unique. It finds unique rows in a NumPy 2D arra...">unordered_unique()</a></code>'s management of the GIL and OpenMP for more information. It is the very last function inside of <code>paulicpp/pauliarray/src/paulicpp.hpp</code></p>
<blockquote class="doxtable">
<p>&zwj;Note: The Python language is working towards removing the GIL. This could take many years before it is accomplished, buf if/when it finished, there will likely be some breakage around any parts explicitly managing the GIL. See <a href="https://peps.python.org/pep-0703/">PEP 703</a> </p>
</blockquote>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6
</small></address>
</body>
</html>
